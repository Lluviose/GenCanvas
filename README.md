# GenCanvas / 智绘画布（纯前端直连）

一款面向「文生图创作」的**可视化工作台**：用画布/图谱把创作过程从线性历史升级为可分叉、可回溯、可整理的探索地图，帮助高频试错与迭代 Prompt，并将优质 Prompt 与图片沉淀为可复用资产。

本项目为 **Gemini 图像生成模型（默认 `gemini-3-pro-image-preview`）** 设计；提示词/图片的分析与打标签使用**另一个多模态模型**（同样走 Gemini 风格请求）。

## 产品目标（对照）

- 把「生成试错过程」可视化：画布中直接看到分支与路线，不再是长历史列表。
- 探索更快：并发生成 + 同屏快速比较。
- 结果可继承：从任意节点继续生成，自然产生分支。
- Prompt 变资产：可收藏、可标签化、可检索、可复用。
- AI 辅助整理：自动打标签、评分/摘要（可选）。

## 核心概念

- **项目（Project）**：用于组织不同主题的创作图谱。
- **画布（Canvas）**：一个主题/任务的创作空间（节点 + 连线构成的探索路径图）。
- **节点（Node）**：一次尝试的最小单元：`prompt + 参数 + 生成结果 + 状态 + 迭代关系`。
- **分支（Branch）**：从节点继续生成创建子节点并自动连线；用于探索方向变化（风格/构图/氛围等）。
- **资产（Assets）**：全局图片库与提示词库，支持搜索/标签/收藏并回到工作台复用。
- **版本历史（Revisions）**：同一节点内编辑提示词/参数会自动记录旧版本，可一键还原。

## 快速开始

环境：Node.js 18+

```bash
npm install
```

开发（Vite）：

```bash
npm run dev
```

本地预览（先构建，再预览 `dist/`）：

```bash
npm run build
npm start
```

访问：

- 工作台：`http://localhost:34567/`（会重定向到 `/workbench`）
- 项目：`http://localhost:34567/projects`
- 画布列表：`http://localhost:34567/projects/:projectId/canvases`
- 资产库：`http://localhost:34567/gallery`
- API 配置：`http://localhost:34567/admin`

## 关键使用流程（业务流程）

1. **进入工作台**：`/workbench` 会自动打开“上次画布”，否则进入第一个项目的默认画布。
2. **进入画布列表**：在 `/projects` 选择项目进入 `/projects/:projectId/canvases`，可新建/复制/重命名画布。
3. **在画布创建节点**：双击空白处创建节点（默认继承当前选中节点的 prompt 与参数）。
4. **生成与分支**：
   - 节点卡片「生成」：在当前节点生成图片。
   - 节点卡片「继续」：一键创建子节点并立即生成（轻量分叉）。
   - 节点卡片「快速微调」：输入一行变化（如“插画风/特写/雨夜”）回车分叉并生成。
   - 右侧详情「批量分叉」：每行一个变化，批量创建分支并可并发生成。
   - 提示词输入框支持在文字中**插入参考图**（点击输入框右侧 `+`），并可点击图片添加**文字标注**。
5. **对比**：框选/多选多个节点，右侧进入“对比视图”，可批量生成并横向看缩略图。
6. **沉淀与找回**：
   - 收藏图片（星标）进入全局图片库。
   - 收藏节点会同步沉淀到提示词库（可搜索/标签化/再复用）。
   - 资产库中可一键把「提示词」或「图片（作为参考图）」发送回工作台创建新节点继续探索。

## 配置与模型

- API 配置页：`/admin`
  - 生成：Gemini 原生（`generativelanguage.googleapis.com`）或 OpenAI 兼容（`/v1/chat/completions`）
  - 分析：可独立配置分析模型与 Key（用于 Prompt/图片分析与标签化）

说明：

- 本项目已改为**纯前端直连外部 API**，API Key **仅保存在本地浏览器**（`localStorage`）。
- 若你在公司/学校网络或某些浏览器环境下遇到请求失败，常见原因是 **CORS 限制**：部分第三方接口不允许从浏览器直接调用。

## 数据持久化（当前）

当前为本地单机 MVP：数据保存在浏览器 `localStorage`。

- 画布列表：`photopro:canvases:<projectId>`
- 画布快照：`photopro:canvas-state:<projectId>:<canvasId>`（nodes/edges）
- 全局图片库：`photopro:gallery-images`
- 提示词资产库：`photopro:prompt-library`
- 项目列表：`photopro:projects`
- 工作台 API 配置：`photopro:workbench-settings`
- 工作台偏好与 AI 特性：`photopro:workbench-preferences`
- WebDAV 配置：`photopro:webdav-config`

## 数据备份

支持两种备份方式（`/backup` 页面）：

### 本地导出/导入
- 导出图片库、提示词库、项目、画布为 JSON 文件
- 导入时可选择“合并”或“替换”模式

### WebDAV 云备份
- 支持坚果云、Nextcloud 等 WebDAV 服务
- 坚果云配置示例：
  - 服务器：`https://dav.jianguoyun.com/dav`
  - 用户名：你的邮箱
  - 密码：应用密码（在 账户设置 → 安全选项 → 第三方应用管理 创建）

## API 调用方式

本项目不再提供 `/api/*` 后端代理。

- 生成/分析接口在浏览器中直接请求 Gemini/OpenAI
- API Key 由用户自行在 `/admin`（API 配置）填写并保存到本地

## 开源发布到 GitHub

- 已提供 `LICENSE`（MIT）与 `.gitignore`（忽略 `node_modules/`、`dist/`、`.env*`）。
- 参考资料（如 `gemini api文档和api参考.md`、`生图前端4.9-修改版.html`）默认已被 `.gitignore` 排除；如需公开发布，请先确认版权/授权允许分发。
- 不要把任何 API Key 写入仓库（本项目默认只把 Key 保存在浏览器 `localStorage`）。

## 代码结构速览

- `src/pages/*`：页面（Projects/Canvases/Canvas/Gallery/Admin/Backup/Settings）
- `src/components/canvas/*`：画布节点与右侧栏（节点卡片、对比/检索/分支操作）
- `src/store/*`：Zustand 状态与业务逻辑（画布列表/节点/分支/并发生成/资产/版本历史）
- `src/store/workbenchSettingsStore.ts`：工作台 API 配置（本地存储）
- `src/services/workbenchApi.ts`：浏览器直连 Gemini/OpenAI 的请求封装
- `src/services/backupService.ts`：本地导出/导入 + WebDAV 云备份
- `src/types/*`：类型与数据结构（Node/Revision/Workbench API 等）

## 当前已实现（相对设计目标）

- 多画布管理：画布列表、新建、重命名、复制、删除（保留默认画布）。
- 分叉与路线可视化：节点显示父/子关系与状态，支持跳转聚焦。
- 轻量分叉：一键继续、快速微调回车继续、批量分叉并发生成。
- 并发生成：多选节点批量生成（并发数可选），队列/运行状态可见。
- 资产沉淀：图片库/提示词库（收藏、标签、搜索、排序、复用回工作台）。
- AI 自动整理：生成后可自动分析提示词/图片，产出标签与评分（有 key 时）。
- 结构化提示词：提示词内可插入参考图，支持点击图片添加标注，并随请求发送。
- 继续生成增强：基于某张生成结果继续生成时，可选「仅发送该图」或「多轮对话（含历史节点）」模式。
- AI 对话模式：对单张图片开启分析模型对话，一键预设提问，AI 回复可编辑并一键分叉生成。
- 节点版本历史：同节点内编辑会自动记录旧版本，可一键还原/还原并生成。
- 数据备份：本地导出/导入 + WebDAV 云备份（坚果云/Nextcloud）。

## AI 特性（设置入口）

- 设置页：`/settings` → **AI 特性**。
  - 生成后自动分析：生成完成后自动跑提示词/图片分析并补全标签与评分（需要在 `/admin` 配置分析 Key）。
  - 高质量阈值：资产库“只看高质量”使用该阈值过滤（图片/提示词分别配置）。
  - AI 对话：支持是否携带历史、最多保留消息数、系统提示、以及“一键预设”管理。
- 工作台侧边栏：在「生成结果」区域选择图片后可点 **AI对话**，或在「图片分析」里一键用建议创建分支/继续生成。
- 多轮对话继续生成：会沿父子链路拼接 `contents` 发送历史；若历史图片带有 `thought_signature` 会优先用于上下文，否则会降级为 user 参考图。

## 不足与下一步（建议优先级）

1. **进度与体验（高优）**：生成是同步请求，节点仅有状态无“第 N 张/总数”的细粒度进度；可考虑 SSE/流式或分批回写。
2. **收藏体系还不完整（中优）**：节点收藏目前主要沉淀为“提示词资产”；缺少“精选库/合集”（把图片+节点打包成可复用方案）。
3. **全局找回能力（中优）**：当前全局主要靠图片/提示词库；缺少跨画布的“节点级”全文检索与标签过滤。
4. **分支表达（中优）**：目前用 `notes` 表达分支方向，后续可引入“分支命名/折叠/分组/对比视图增强”。
#   G e n C a n v a s  
 
